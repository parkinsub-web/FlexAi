#!/usr/bin/env sh

# Auto-push the current branch to origin after each commit.
set -eu

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
[ -n "$repo_root" ] || exit 0

cd "$repo_root"

# Skip when Git is in a state where auto-push is risky or noisy.
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ] || [ -f ".git/MERGE_HEAD" ]; then
  exit 0
fi

branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
[ -n "$branch" ] || exit 0

remote="${AUTO_PUSH_REMOTE:-origin}"

if git config --get "remote.$remote.url" >/dev/null 2>&1; then
  echo "[post-commit] Auto-pushing $branch to $remote..."
  git push "$remote" "$branch"
fi
